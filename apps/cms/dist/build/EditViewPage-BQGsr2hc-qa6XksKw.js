import{aZ as b,s as te,ad as se,b0 as Y,r as g,b$ as ne,cC as ae,ao as ie,aF as oe,aY as re,an as ce,ae as le,ba as de,j as e,P as L,ay as pe,at as ue,az as ge,aA as me,b5 as T,cF as G,cG as he,bs as H,cH as fe,av as w,ax as $,bj as k,b4 as h,bk as m,cI as v,cJ as xe,cm as q,cK as ye,J as D,cL as Ae}from"./strapi-BWAWKOj2.js";import{b as ke,c as Te,d as Ee}from"./apiTokens-ByCd8ZnO-wZLQJbnq.js";import{A as _}from"./constants-CRj0ViV1-Q2dfXdfa.js";import{F as je,T as Ie,a as Ce,b as Se,L as be,c as Pe}from"./TokenTypeSelect-DoRYgO8G-HT3B5t0a.js";import{t as _e,m as ve}from"./tail-DduAxsmk.js";import"./transferTokens-CQP13miB-Dkz5yG70.js";import"./index-DQF-Fl2W.js";import"./index-BRVyLNfZ.js";import"./_baseMap-e93yDYG_.js";import"./_baseEach-DDDKmNKC.js";const Re=de.injectEndpoints({endpoints:s=>({getPermissions:s.query({query:()=>"/admin/content-api/permissions",transformResponse:t=>t.data}),getRoutes:s.query({query:()=>"/admin/content-api/routes",transformResponse:t=>t.data})}),overrideExisting:!1}),{useGetPermissionsQuery:Le,useGetRoutesQuery:Ne}=Re,[Oe,Me]=he("ApiTokenPermissionsContext"),we=({children:s,...t})=>e.jsx(Oe,{...t,children:s}),U=()=>Me("useApiTokenPermissions"),$e=({errors:s={},onChange:t,canEditInputs:a,isCreating:o,values:n={},apiToken:u={},onDispatch:c,setHasChangedPermissions:E})=>{const{formatMessage:f}=b(),x=({target:{value:r}})=>{E(!1),r==="full-access"&&c({type:"SELECT_ALL_ACTIONS"}),r==="read-only"&&c({type:"ON_CHANGE_READ_ONLY"})},P=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return e.jsx(k,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:e.jsxs(T,{direction:"column",alignItems:"stretch",gap:4,children:[e.jsx(h,{variant:"delta",tag:"h2",children:f({id:"global.details",defaultMessage:"Details"})}),e.jsxs(m.Root,{gap:5,children:[e.jsx(m.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Ce,{error:s.name,value:n.name,canEditInputs:a,onChange:t})},"name"),e.jsx(m.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Se,{error:s.description,value:n.description,canEditInputs:a,onChange:t})},"description"),e.jsx(m.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(be,{isCreating:o,error:s.lifespan,value:n.lifespan,onChange:t,token:u})},"lifespan"),e.jsx(m.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Pe,{value:n.type,error:s.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:r=>{x({target:{value:r}}),t({target:{name:"type",value:r}})},options:P,canEditInputs:a})},"type")]})]})})},De=s=>{switch(s){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},Ue=D(k)`
  margin: -1px;
  border-radius: ${({theme:s})=>s.spaces[1]} 0 0 ${({theme:s})=>s.spaces[1]};
`,Be=({route:s={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:t}=b(),{method:a,handler:o,path:n}=s,u=n?_e(n.split("/")):[],[c="",E=""]=o?o.split("."):[],f=De(s.method);return e.jsxs(T,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsxs(h,{variant:"delta",tag:"h3",children:[t({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"Â ",e.jsx("span",{children:c}),e.jsxs(h,{variant:"delta",textColor:"primary600",children:[".",E]})]}),e.jsxs(T,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[e.jsx(Ue,{background:f.background,borderColor:f.border,padding:2,children:e.jsx(h,{fontWeight:"bold",textColor:f.text,children:a})}),e.jsx(k,{paddingLeft:2,paddingRight:2,children:ve(u,x=>e.jsxs(h,{textColor:x.includes(":")?"neutral600":"neutral900",children:["/",x]},x))})]})]})},Fe=()=>{const{value:{selectedAction:s,routes:t}}=U(),{formatMessage:a}=b(),o=s?.split(".")[0];return e.jsx(m.Item,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},direction:"column",alignItems:"stretch",children:s?e.jsx(T,{direction:"column",alignItems:"stretch",gap:2,children:o&&o in t&&t[o].map(n=>n.config.auth?.scope?.includes(s)||n.handler===s?e.jsx(Be,{route:n},n.handler):null)}):e.jsxs(T,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(h,{variant:"delta",tag:"h3",children:a({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),e.jsx(h,{tag:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},V=Ae`
  background: ${s=>s.theme.colors.primary100};

  #cog {
    opacity: 1;
  }
`,Ge=D(k)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  #cog {
    opacity: 0;
    path {
      fill: ${s=>s.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${s=>s.$isActive&&V}
  &:hover {
    ${V}
  }
`,He=D.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:s})=>s.colors.neutral150};
`,qe=({controllers:s=[],label:t,orderNumber:a=0,disabled:o=!1})=>{const{value:{onChangeSelectAll:n,onChange:u,selectedActions:c,setSelectedAction:E,selectedAction:f}}=U(),{formatMessage:x}=b(),P=r=>r===f;return e.jsxs(v.Item,{value:`${t}-${a}`,children:[e.jsx(v.Header,{variant:a%2?"primary":"secondary",children:e.jsx(v.Trigger,{children:xe(t)})}),e.jsx(v.Content,{children:s?.map(r=>{const p=r.actions.every(d=>c.includes(d.actionId)),B=r.actions.some(d=>c.includes(d.actionId));return e.jsxs(k,{children:[e.jsxs(T,{justifyContent:"space-between",alignItems:"center",padding:4,children:[e.jsx(k,{paddingRight:4,children:e.jsx(h,{variant:"sigma",textColor:"neutral600",children:r?.controller})}),e.jsx(He,{}),e.jsx(k,{paddingLeft:4,children:e.jsx(q,{checked:!p&&B?"indeterminate":p,onCheckedChange:()=>{n({target:{value:[...r.actions]}})},disabled:o,children:x({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),e.jsx(m.Root,{gap:4,padding:4,children:r?.actions&&r?.actions.map(d=>e.jsx(m.Item,{col:6,direction:"column",alignItems:"stretch",children:e.jsxs(Ge,{$isActive:P(d.actionId),padding:2,hasRadius:!0,children:[e.jsx(q,{checked:c.includes(d.actionId),name:d.actionId,onCheckedChange:()=>{u({target:{value:d.actionId}})},disabled:o,children:d.action}),e.jsx("button",{type:"button","data-testid":"action-cog",onClick:()=>E({target:{value:d.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:e.jsx(ye,{id:"cog"})})]})},d.actionId))})]},`${t}.${r?.controller}`)})})]})},Ve=({section:s=null,...t})=>e.jsx(k,{padding:4,background:"neutral0",children:e.jsx(v.Root,{size:"M",children:s&&s.map((a,o)=>e.jsx(qe,{label:a.label,controllers:a.controllers,orderNumber:o,...t},a.apiId))})}),Ye=({...s})=>{const{value:{data:t}}=U(),{formatMessage:a}=b();return e.jsxs(m.Root,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[e.jsxs(m.Item,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,direction:"column",alignItems:"stretch",children:[e.jsxs(T,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(h,{variant:"delta",tag:"h2",children:a({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),e.jsx(h,{tag:"p",textColor:"neutral600",children:a({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),t?.permissions&&e.jsx(Ve,{section:t?.permissions,...s})]}),e.jsx(Fe,{})]})},Qe=ue().shape({name:w().max(100).required($.required.id),type:w().oneOf(["read-only","full-access","custom"]).required($.required.id),description:w().nullable(),lifespan:fe().integer().min(0).nullable().defined($.required.id)}),ze=s=>{const t={allActionsIds:[],permissions:[]};return t.permissions=Object.entries(s).map(([a,o])=>({apiId:a,label:a.split("::")[1],controllers:Object.keys(o.controllers).map(n=>({controller:n,actions:n in o.controllers?o.controllers[n].map(u=>{const c=`${a}.${n}.${u}`;return a.includes("api::")&&t.allActionsIds.push(c),{action:u,actionId:c}}).flat():[]})).flat()})),t},Ke={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},We=(s,t)=>oe(s,a=>{switch(t.type){case"ON_CHANGE":{a.selectedActions.includes(t.value)?G(a.selectedActions,t.value):a.selectedActions.push(t.value);break}case"SELECT_ALL_IN_PERMISSION":{t.value.every(n=>a.selectedActions.includes(n.actionId))?t.value.forEach(n=>{G(a.selectedActions,n.actionId)}):t.value.forEach(n=>{a.selectedActions.push(n.actionId)});break}case"SELECT_ALL_ACTIONS":{a.selectedActions=[...a.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const o=a.data.allActionsIds.filter(n=>n.includes("find")||n.includes("findOne"));a.selectedActions=[...o];break}case"UPDATE_PERMISSIONS_LAYOUT":{a.data=ze(t.value);break}case"UPDATE_ROUTES":{a.routes={...t.value};break}case"UPDATE_PERMISSIONS":{a.selectedActions=[...t.value];break}case"SET_SELECTED_ACTION":{a.selectedAction=t.value;break}default:return a}}),Je=()=>{const{formatMessage:s}=b(),{toggleNotification:t}=te(),{state:a}=se(),o=Y(i=>i.admin_app.permissions),[n,u]=g.useState(a?.apiToken?.accessKey?{...a.apiToken}:null),{trackUsage:c}=ne(),E=ae("EditView",i=>i.setCurrentStep),{allowedActions:{canCreate:f,canUpdate:x,canRegenerate:P}}=ie(o.settings?.["api-tokens"]),[r,p]=g.useReducer(We,Ke),d=re("/settings/api-tokens/:id")?.params?.id,y=d==="create",{_unstableFormatAPIError:A,_unstableFormatValidationErrors:F}=ce(),Q=le(),I=Le(),C=Ne();g.useEffect(()=>{I.error&&t({type:"danger",message:A(I.error)})},[I.error,A,t]),g.useEffect(()=>{C.error&&t({type:"danger",message:A(C.error)})},[C.error,A,t]),g.useEffect(()=>{I.data&&p({type:"UPDATE_PERMISSIONS_LAYOUT",value:I.data})},[I.data]),g.useEffect(()=>{C.data&&p({type:"UPDATE_ROUTES",value:C.data})},[C.data]),g.useEffect(()=>{n&&(n.type==="read-only"&&p({type:"ON_CHANGE_READ_ONLY"}),n.type==="full-access"&&p({type:"SELECT_ALL_ACTIONS"}),n.type==="custom"&&p({type:"UPDATE_PERMISSIONS",value:n?.permissions}))},[n]),g.useEffect(()=>{c(y?"didAddTokenFromList":"didEditTokenFromList",{tokenType:_})},[y,c]);const{data:j,error:N,isLoading:z}=ke(d,{skip:!d||y||!!n});g.useEffect(()=>{N&&t({type:"danger",message:A(N)})},[N,A,t]),g.useEffect(()=>{j&&(u(j),j.type==="read-only"&&p({type:"ON_CHANGE_READ_ONLY"}),j.type==="full-access"&&p({type:"SELECT_ALL_ACTIONS"}),j.type==="custom"&&p({type:"UPDATE_PERMISSIONS",value:j?.permissions}))},[j]);const[K]=Te(),[W]=Ee(),J=async(i,S)=>{c(y?"willCreateToken":"willEditToken",{tokenType:_});try{if(y){const l=await K({...i,lifespan:i?.lifespan&&i.lifespan!=="0"?parseInt(i.lifespan.toString(),10):null,permissions:i.type==="custom"?r.selectedActions:null});if("error"in l){H(l.error)&&l.error.name==="ValidationError"?S.setErrors(F(l.error)):t({type:"danger",message:A(l.error)});return}t({type:"success",message:s({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),c("didCreateToken",{type:l.data.type,tokenType:_}),Q(`../api-tokens/${l.data.id.toString()}`,{state:{apiToken:l.data},replace:!0}),E("apiTokens.success")}else{const l=await W({id:d,name:i.name,description:i.description,type:i.type,permissions:i.type==="custom"?r.selectedActions:null});if("error"in l){H(l.error)&&l.error.name==="ValidationError"?S.setErrors(F(l.error)):t({type:"danger",message:A(l.error)});return}t({type:"success",message:s({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),c("didEditToken",{type:l.data.type,tokenType:_})}}catch{t({type:"danger",message:s({id:"notification.error",defaultMessage:"Something went wrong"})})}},[Z,O]=g.useState(!1),X={...r,onChange:({target:{value:i}})=>{O(!0),p({type:"ON_CHANGE",value:i})},onChangeSelectAll:({target:{value:i}})=>{O(!0),p({type:"SELECT_ALL_IN_PERMISSION",value:i})},setSelectedAction:({target:{value:i}})=>{p({type:"SET_SELECTED_ACTION",value:i})}},M=x&&!y||f&&y;return z?e.jsx(L.Loading,{}):e.jsx(we,{value:X,children:e.jsxs(L.Main,{children:[e.jsx(L.Title,{children:s({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:"API Tokens"})}),e.jsx(pe,{validationSchema:Qe,validateOnChange:!1,initialValues:{name:n?.name||"",description:n?.description||"",type:n?.type,lifespan:n?.lifespan},enableReinitialize:!0,onSubmit:(i,S)=>J(i,S),children:({errors:i,handleChange:S,isSubmitting:l,values:R,setFieldValue:ee})=>(Z&&R?.type!=="custom"&&ee("type","custom"),e.jsxs(ge,{children:[e.jsx(je,{title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:n,setToken:u,canEditInputs:M,canRegenerate:P,isSubmitting:l,regenerateUrl:"/admin/api-tokens/"}),e.jsx(me.Content,{children:e.jsxs(T,{direction:"column",alignItems:"stretch",gap:6,children:[!!n?.name&&e.jsx(Ie,{token:n?.accessKey,tokenType:_}),e.jsx($e,{errors:i,onChange:S,canEditInputs:M,isCreating:y,values:R,apiToken:n,onDispatch:p,setHasChangedPermissions:O}),e.jsx(Ye,{disabled:!M||R?.type==="read-only"||R?.type==="full-access"})]})})]}))})]})})},pt=()=>{const s=Y(t=>t.admin_app.permissions.settings?.["api-tokens"].read);return e.jsx(L.Protect,{permissions:s,children:e.jsx(Je,{})})};export{Je as EditView,pt as ProtectedEditView};
